<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Large-scale example · FletcherPenaltySolver</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/style.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FletcherPenaltySolver</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../fine-tuneFPS/">Fine-tune FPS</a></li><li class="is-active"><a class="tocitem" href>Large-scale example</a><ul class="internal"><li><a class="tocitem" href="#Problem-Statement"><span>Problem Statement</span></a></li><li><a class="tocitem" href="#Find-a-Feasible-Point"><span>Find a Feasible Point</span></a></li><li><a class="tocitem" href="#Solve-the-Problem"><span>Solve the Problem</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Large-scale example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Large-scale example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaSmoothOptimizers/FletcherPenaltySolver.jl/blob/main/docs/assets/example.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p><a href="https://mybinder.org/v2/gh/JuliaSmoothOptimizers/FletcherPenaltySolver.jl/gh-pages?labpath=dev%2Fexample.ipynb"><img src="https://mybinder.org/badge_logo.svg" alt="Binder"/></a></p><h1 id="Solve-Large-Scale-Problem-with-FletcherPenaltySolver.jl"><a class="docs-heading-anchor" href="#Solve-Large-Scale-Problem-with-FletcherPenaltySolver.jl">Solve Large-Scale Problem with FletcherPenaltySolver.jl</a><a id="Solve-Large-Scale-Problem-with-FletcherPenaltySolver.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Solve-Large-Scale-Problem-with-FletcherPenaltySolver.jl" title="Permalink"></a></h1><p>In this tutorial we use <code>fps_solve</code> to solve a large-scale optimization problem resulting from the discretization of a PDE-constrained optimization problem and compare the solve with Ipopt.</p><h2 id="Problem-Statement"><a class="docs-heading-anchor" href="#Problem-Statement">Problem Statement</a><a id="Problem-Statement-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Statement" title="Permalink"></a></h2><p>Let Ω = (-1,1)², we solve the following distributed Poisson control problem with Dirichlet boundary:</p><p class="math-container">\[   \left\lbrace
   \begin{aligned}
      \min_{y \in H^1_0, u \in H^1} \quad &amp;  \frac{1}{2} \int_\Omega |y(x) - y_d(x)|^2dx + \frac{\alpha}{2} \int_\Omega |u|^2dx \\
      \text{s.t.} &amp; -\Delta y = h + u, \quad x \in \Omega, \\
                  &amp; y = 0, \quad x \in \partial \Omega,
   \end{aligned}
   \right.\]</p><p>where yd(x) = -x₁² and α = 1e-2. The force term is h(x₁, x₂) = - sin(ω x₁)sin(ω x₂) with  ω = π - 1/8.</p><p>We refer to <a href="https://github.com/gridap/Gridap.jl">Gridap.jl</a> for more details on modeling PDEs and <a href="https://github.com/JuliaSmoothOptimizers/PDENLPModels.jl">PDENLPModels.jl</a> for PDE-constrained optimization problems.</p><pre><code class="language-julia hljs">using Gridap, PDENLPModels</code></pre><p>Definition of the domain and discretization</p><pre><code class="language-julia hljs">n = 20
domain = (-1, 1, -1, 1)
partition = (n, n)
model = CartesianDiscreteModel(domain, partition)</code></pre><pre><code class="nohighlight hljs">CartesianDiscreteModel()</code></pre><p>Definition of the FE-spaces</p><pre><code class="language-julia hljs">reffe = ReferenceFE(lagrangian, Float64, 2)
Xpde = TestFESpace(model, reffe; conformity = :H1, dirichlet_tags = &quot;boundary&quot;)
y0(x) = 0.0
Ypde = TrialFESpace(Xpde, y0)

reffe_con = ReferenceFE(lagrangian, Float64, 1)
Xcon = TestFESpace(model, reffe_con; conformity = :H1)
Ycon = TrialFESpace(Xcon)
Y = MultiFieldFESpace([Ypde, Ycon])</code></pre><pre><code class="nohighlight hljs">MultiFieldFESpace()</code></pre><p>Integration machinery</p><pre><code class="language-julia hljs">trian = Triangulation(model)
degree = 1
dΩ = Measure(trian, degree)</code></pre><pre><code class="nohighlight hljs">Measure()</code></pre><p>Objective function</p><pre><code class="language-julia hljs">yd(x) = -x[1]^2
α = 1e-2
function f(y, u)
  ∫(0.5 * (yd - y) * (yd - y) + 0.5 * α * u * u) * dΩ
end</code></pre><pre><code class="nohighlight hljs">f (generic function with 1 method)</code></pre><p>Definition of the constraint operator</p><pre><code class="language-julia hljs">ω = π - 1 / 8
h(x) = -sin(ω * x[1]) * sin(ω * x[2])
function res(y, u, v)
  ∫(∇(v) ⊙ ∇(y) - v * u - v * h) * dΩ
end
op = FEOperator(res, Y, Xpde)</code></pre><pre><code class="nohighlight hljs">FEOperatorFromWeakForm()</code></pre><p>Definition of the initial guess</p><pre><code class="language-julia hljs">npde = Gridap.FESpaces.num_free_dofs(Ypde)
ncon = Gridap.FESpaces.num_free_dofs(Ycon)
x0 = zeros(npde + ncon);</code></pre><p>Overall, we built a GridapPDENLPModel, which implements the <a href="https://github.com/JuliaSmoothOptimizers/NLPModels.jl">NLPModels.jl</a> API.</p><pre><code class="language-julia hljs">nlp = GridapPDENLPModel(x0, f, trian, Ypde, Ycon, Xpde, Xcon, op, name = &quot;Control elastic membrane&quot;)

(nlp.meta.nvar, nlp.meta.ncon)</code></pre><pre><code class="nohighlight hljs">(1962, 1521)</code></pre><h2 id="Find-a-Feasible-Point"><a class="docs-heading-anchor" href="#Find-a-Feasible-Point">Find a Feasible Point</a><a id="Find-a-Feasible-Point-1"></a><a class="docs-heading-anchor-permalink" href="#Find-a-Feasible-Point" title="Permalink"></a></h2><p>Before solving the previously defined model, we will first improve our initial guess. We use <code>FeasibilityResidual</code> from <a href="https://github.com/JuliaSmoothOptimizers/NLPModelsModifiers.jl">NLPModelsModifiers.jl</a> to convert the NLPModel as an NLSModel. Then, using <code>trunk</code>, a solver for least-squares problems implemented in <a href="https://github.com/JuliaSmoothOptimizers/JSOSolvers.jl">JSOSolvers.jl</a>, we find An improved guess which is close to being feasible for our large-scale problem. By default, a JSO-compliant solver such as <code>trunk</code> (the same applies to <code>fps_solve</code>) uses by default <code>nlp.meta.x0</code> as an initial guess.</p><pre><code class="language-julia hljs">using JSOSolvers, NLPModelsModifiers

nls = FeasibilityResidual(nlp)
stats_trunk = trunk(nls)</code></pre><pre><code class="nohighlight hljs">&quot;Execution stats: first-order stationary&quot;</code></pre><p>We check the solution from the stats returned by <code>trunk</code>:</p><pre><code class="language-julia hljs">norm(cons(nlp, stats_trunk.solution))</code></pre><pre><code class="nohighlight hljs">1.6058259477971256e-5</code></pre><p>We will use the solution found to initialize our solvers.</p><h2 id="Solve-the-Problem"><a class="docs-heading-anchor" href="#Solve-the-Problem">Solve the Problem</a><a id="Solve-the-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Solve-the-Problem" title="Permalink"></a></h2><p>Finally, we are ready to solve the PDE-constrained optimization problem with a targeted tolerance of <code>1e-5</code>. In the following, we will use both Ipopt and DCI on our problem.</p><pre><code class="language-julia hljs">using NLPModelsIpopt

stats_ipopt = ipopt(nlp, x0 = stats_trunk.solution, tol = 1e-5, print_level = 0)</code></pre><pre><code class="nohighlight hljs">&quot;Execution stats: first-order stationary&quot;</code></pre><p>The problem was successfully solved, and we can extract the function evaluations from the stats.</p><pre><code class="language-julia hljs">nlp.counters</code></pre><pre><code class="nohighlight hljs">  Counters:
             obj: ██████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 9                 grad: ███████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 10                cons: ████████████⋅⋅⋅⋅⋅⋅⋅⋅ 18    
        cons_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0             cons_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 jcon: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           jgrad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                  jac: ███████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 10             jac_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
         jac_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jprod: ███████████████⋅⋅⋅⋅⋅ 22           jprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
       jprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jtprod: ████████████████████ 30          jtprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
      jtprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 hess: ██████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 8                hprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           jhess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jhprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
</code></pre><p>Reinitialize the counters before re-solving.</p><pre><code class="language-julia hljs">reset!(nlp);</code></pre><p><code>NullLogger</code> avoids printing iteration information.</p><pre><code class="language-julia hljs">using FletcherPenaltySolver, Logging

stats_fps_solve = with_logger(NullLogger()) do
  fps_solve(nlp, stats_trunk.solution, atol = 1e-5, rtol = 1e-5)
end</code></pre><pre><code class="nohighlight hljs">&quot;Execution stats: first-order stationary&quot;</code></pre><p>The problem was successfully solved, and we can extract the function evaluations from the stats.</p><pre><code class="language-julia hljs">nlp.counters</code></pre><pre><code class="nohighlight hljs">  Counters:
             obj: ██████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 3                 grad: ████████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4                 cons: ████████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4     
        cons_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0             cons_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 jcon: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           jgrad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                  jac: ████████████⋅⋅⋅⋅⋅⋅⋅⋅ 6              jac_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
         jac_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0            jprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
       jprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jtprod: ██████████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 5           jtprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
      jtprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 hess: ████████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4                hprod: ████████████████████ 10    
           jhess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jhprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
</code></pre><p>We now compare the two solvers with respect to the time spent,</p><pre><code class="language-julia hljs">stats_ipopt.elapsed_time, stats_fps_solve.elapsed_time</code></pre><pre><code class="nohighlight hljs">(31.964, 42.67502021789551)</code></pre><p>and also check objective value, feasibility and dual feasibility of <code>ipopt</code> and <code>fps_solve</code>.</p><pre><code class="language-julia hljs">(stats_ipopt.objective, stats_ipopt.primal_feas, stats_ipopt.dual_feas),
(stats_fps_solve.objective, stats_fps_solve.primal_feas, stats_fps_solve.dual_feas)</code></pre><pre><code class="nohighlight hljs">((0.005425026428348349, 1.1102230246251568e-18, 4.2724309076258577e-7), (0.005425025968573663, 1.1102230246251568e-18, 2.968652346957424e-7))</code></pre><p>Overall <code>FletcherPenaltySolver</code> is doing great for solving large-scale optimization problems!</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../fine-tuneFPS/">« Fine-tune FPS</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 29 August 2022 19:02">Monday 29 August 2022</span>. Using Julia version 1.8.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
